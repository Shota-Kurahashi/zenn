---
title: '【Next.js App Router】Route Segment Configのページレンダリング手法をまとめてみた'
emoji: '⚙️'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['nextjs', 'typescript', 'react', 'frontend', 'javascript']
published: false
---

Next.js の App Router の Route Segment Config でページのレンダリングを制御する方法についてまとめてみました。

Next.js 14.1.0 で検証しています。

## Route Segment Config とは

Next.js 13 App Router から追加された機能で、ページ全体のレンダリングを制御することができます。

`layout.tsx`や`page.tsx`,`Route Handler`で以下のような設定をすることで、ページのレンダリングを制御することができます。
また、設定することにより`fetch`の**デフォルトの設定**を変更することができます。

```tsx
// 静的レンダリングを強制する
export const dynamic = 'force-static';
```

Router Segment Config は以下の 7 つの設定があります。

- [`dynamic`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#dynamic)
- [`dynamicParams`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#dynamicparams)
- [`revalidate`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#revalidate)
- [`fetchCache`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#fetchcache)
- [`runtime`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#runtime)
- [`preferredRegion`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#preferredregion)
- [`maxDuration`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#maxduration)

https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config

## dynamic

`dynamic` はそのページを静的または動的にレンダリングするかを制御します。
`layout.tsx`や`page.tsx`,`Route Handler`で以下のように宣言することで使用できます。

```tsx
export const dynamic = '...';
```

ページ全体を制御するため、App Router 以前の`Pages Router`からのスムーズに移行することができますとのことです。

> Good to know: The new model in the app directory favors granular caching control at the fetch request level over the binary all-or-nothing model of getServerSideProps and getStaticProps at the page-level in the pages directory. The dynamic option is a way to opt back in to the previous model as a convenience and provides a simpler migration path.

### 1. auto

```tsx
export const dynamic = 'auto';
```

**デフォルト**。静的レンダリングになります。ですが、任意のコンポーネントは`fetch`を用いて動的にレンダリングすることができます。

### 2. force-dynamic

```tsx
export const dynamic = 'force-dynamic';
```

完全に動的にレンダリングされるため、設定したページは SSR の挙動になります。
**`Pages Router`の`getServerSideProps()`を使用した場合と同じ挙動になります。**

:::message
同時に`fetch`の動作を検証したところ、`fetch`に`cache`を指定していない場合は、
`fetch(... ,{ cache:"no-store" })`になり、指定されている場合は、初回のみ
`fetch(... ,{ cache:"no-store" })`で実行され、以降は設定された`cache`の値で実行されます。
:::

### 3. error

```tsx
export const dynamic = 'error';
```

完全に静的なレンダリングを作成し、`fetch`は常に`cache`を使用します。SSG と同じ挙動になります。
**`Pages Router`の`getStaticProps()`を使用した場合と同じ挙動になります。**
もし、そのページの配下のコンポーネントが`fetch(... ,{ cache:"no-store" })`や動的関数を使用している場合は、ビルド時にエラーが発生します。
後述する[`fetchCache`](#fetchcache)の設定が`fetchCache = 'only-cache'`に、[`dynamicParams`](#dynamicparams)の**デフォルトの設定**が`dynamicParams = 'false'`に設定されます。

> dynamic = 'error' changes the default of dynamicParams from true to false. You can opt back into dynamically rendering pages for dynamic params not generated by generateStaticParams by manually setting dynamicParams = true.

### 4. force-static

```tsx
export const dynamic = 'force-static';
```

強制的に静的なレンダリングを実行します。SSG と同じ挙動になります。
[`dynamic = 'error'`](#error)との違いは、ビルド時にエラーを発生させない点です。
もし、`cookie()`や`header()`,`useSearchParam()`などの動的な関数を使用している場合、それらの関数の返り値は空の値になります。

### dynamic まとめ

4 つの設定があります。

1. `auto` ... デフォルト
2. `force-dynamic` ... SSR の挙動で`getServerSideProps()`と同じ挙動になります。
3. `error`　... SSG の挙動で`getStaticProps()`と同じ挙動になります。
4. `force-static` ... SSG の挙動で`getStaticProps()`と同じ挙動になります。

## dynamicParams

```tsx
export const dynamicParams = true;
// or
export const dynamicParams = false;
```

[`generateStaticParams`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#generatestaticparams)を使用した際に生成されなかったパスに対しての挙動を制御します。

**`true`の場合は動的に生成。`false`の場合は`404ページ`を表示します。**
デフォルトは**true**です。

dynamic と dynamicParams を組み合わせて使用すると挙動が変わります。

### force-dynamic と true の組み合わせ

```tsx
export const dynamic = 'force-dynamic';
export const dynamicParams = true;
```

`generateStaticParams`で生成したページを**含めて**SSR の挙動になります。

### auto と true の組み合わせ

```tsx
export const dynamic = 'auto';
export const dynamicParams = true;
```

`generateStaticParams`で生成したページは**SSG**の挙動になります。
`generateStaticParams`で生成されなかったページは**初回のみ SSR**の挙動になり、以降は**SSG**の挙動になります。

### error と true の組み合わせ

```tsx
export const dynamic = 'error';
export const dynamicParams = true;
```

auto と同じく、`generateStaticParams`で生成したページは**SSG**の挙動になります。
`generateStaticParams`で生成されなかったページは**初回のみ SSR**の挙動になり、以降は**SSG**の挙動になります。

:::message alert
Next.js 14.1.0 で検証したところ、本来は`dynamic = 'error'`を設定した場合、`dynamicParams`のデフォルトの設定が`false`になるはずでが、`true`のままでした。
404 ページを表示させたい場合は、手動で`dynamicParams`を`false`に設定する必要があります。
:::

### dynamicParams まとめ

`true` か `false` で設定します。

`true` ... `generateStaticParams`で生成されなかったページに対しても動的にレンダリングします。
`false` ... `generateStaticParams`で生成されなかったページに対しては 404 ページを表示します。

## revalidate

```tsx
export const revalidate = ...;
```

ページの再生成を制御します。ISR と同じ挙動になります。
**`fetch`に revalidate**が設定されている場合、`fetch`の再実行が優先されます。
:::message
`revalidate`の設定に数式を使用することはできません。

✗ `export const revalidate = 60 * 60 * 24;`

○ `export const revalidate = 86400;`
:::

### 1. false

```tsx
export const revalidate = false;
```

**デフォルト**。キャッシュを使用して再生成されません。SSG と同じ挙動になります。

### 2. 0

```tsx
export const revalidate = 0;
```

`fetch`に`cache`の設定がない場合、SSR と同じ挙動になります。
`dynamic = 'force-dynamic'`と同じ挙動になります。

### 3. number

```tsx
export const revalidate = 60;
```

指定した秒数後に再生成されます。

:::message
`revalidate`と`dynamic`を同時に設定した場合、`revalidate`の設定が優先されます。
また、ページ内に複数の`revalidate`が設定されている場合、最も小さい値が優先されます。
:::

### revalidate まとめ

`false` か `0` か `number` で設定します。

`false` ... SSG と同じ挙動になります。
`0` ... `fetch`に`cache`の設定がない場合、SSR と同じ挙動になります。
`number` ... 指定した秒数後に再生成されます。

## fetchCache

:::message alert
これは、デフォルトの挙動を明示的に上書きする必要がある場合にのみ使用すべき、高度なオプションです。

> This is an advanced option that should only be used if you specifically need to override the default behavior.

:::

```tsx
export const fetchCache = ...;
```

`fetch`のデフォルトの設定を変更したり、`fetch`のキャッシュを制御します。

### 1. auto

```tsx
export const fetchCache = 'auto';
```

**デフォルト**。`cache`を使用し、動的関数を使用している場合は`cache`を使用しません。

### 2. default-cache

```tsx
export const fetchCache = 'default-cache';
```

**基本的に**`cache`を使用します。`no-store`が明示的に設定されている場合は、`cache`を使用しません。
`auto`との違いは、`cookie()`などの動的関数を使用していても`cache`を使用します。

### 3. only-cache

```tsx
export const fetchCache = 'only-cache';
```

すべての`fetch`で`cache`を使用します。`no-store`が明示的に設定されている場合は、エラーが発生します。

### 4. force-cache

```tsx
export const fetchCache = 'force-cache';
```

すべての`fetch`で`cache`を使用します。`no-store`が明示的に設定されている場合でも、`cache`を使用します。

### 5. default-no-store

```tsx
export const fetchCache = 'default-no-store';
```

**基本的に**`cache`を使用しません。`force-cache`が明示的に設定されている場合は、`cache`を使用します。

### 6. only-no-store

```tsx
export const fetchCache = 'only-no-store';
```

すべての`fetch`で`cache`を使用しません。`cache`が明示的に設定されている場合は、エラーが発生します。

### 7. force-no-store

```tsx
export const fetchCache = 'force-no-store';
```

すべての`fetch`で`cache`を使用しません。`cache`が明示的に設定されている場合でも、`cache`を使用しません。

:::message alert
Next.js 14.1.0 で検証したところ、`fetch`に`force-cache`を設定した場合、`cache`が使用されていたので、正常に動作していませんでした。

> 'force-no-store': Ensure all fetch requests opt out of caching by setting the cache option of all fetch requests to 'no-store'. This forces all fetch requests to be re-fetched every request even if they provide a 'force-cache' option.

:::

### fetchCache まとめ

7 つの設定があります。

1. `auto` ... デフォルト
2. `default-cache` ... 基本的に`cache`を使用します。
3. `only-cache` ... すべての`fetch`で`cache`を使用します。`no-store`が明示的に設定されている場合は、エラーが発生します。
4. `force-cache` ... 強制的にすべての`fetch`で`cache`を使用します。
5. `default-no-store` ... 基本的に`cache`を使用しません。
6. `only-no-store` ... すべての`fetch`で`cache`を使用しません。`cache`が明示的に設定されている場合は、エラーが発生します。
7. `force-no-store` ... 強制的にすべての`fetch`で`cache`を使用しません。

## runtime

```tsx
export const runtime = 'nodejs';
// or
export const runtime = 'edge';
```

実行環境を選択できます。Cloudflare Workers などのエッジ環境にデプロイする場合に使用します。
`edge`を使用した場合、`revalidate`などの ISR の設定が動作しなくなります。

https://nextjs.org/docs/app/building-your-application/rendering/edge-and-nodejs-runtimes

### runtime まとめ

`nodejs` か `edge` で設定します。

`nodejs` ... デフォルト
`edge` ... エッジ環境にデプロイする場合に使用します。

## preferredRegion

```tsx
export const preferredRegion = 'auto';
// 'auto' | 'global' | 'home' | ['iad1', 'sfo1']
```

リージョンを指定できます。デフォルトは`all`で、１番近いリージョンが選択されます。

## maxDuration

```tsx
export const maxDuration = 5;
```

Next.js 13.4.10 で追加された機能で、サーバー側のロジックを実行する最大時間を設定できます。

## issue

`dynamic = 'force-dynamic'`や`fetchCache = 'force-no-store'`などの`cache`を使用しない設定を使用した場合、うまく動作しない場合が多々あります。
なので、`cache`を使用したくない場合は、`fetch`に`{ cache: 'no-store' }`を設定して使用したほうが良いかもしれません。

https://github.com/vercel/next.js/issues/51788

https://github.com/vercel/next.js/issues/49300

https://github.com/vercel/next.js/issues/43879

## まとめ

いくつか意図した挙動にならないので、個別に`fetch`に`cache`を設定したほうがいいと思いました。
`dynamic = error`や`fetchCache = 'only-cache'`などは、エラーを発生させてくれるので完全な静的なページを作成する際には便利だと思いました。

## 最後に

検証してから記載していますが、間違いがあるかもしれません。
もし、間違いを見つけた場合は、ご指摘いただけると幸いです。
ありがとうございました。
