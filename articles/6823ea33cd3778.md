---
title: '【Next.js App Router】Route Segment Configのページレンダリング手法まとめ'
emoji: '⚙️'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['nextjs', 'typescript', 'react', 'frontend', 'javascript']
published: false
---

Next.js の App Router の Route Segment Config でページのレンダリングを制御する方法について紹介します。

Next.js 14.1.0 で検証しています。

## Route Segment Config とは

Next.js 13 App Router から追加された機能で、ページ全体のレンダリングを制御することができます。

`layout.tsx`や`page.tsx`,`Route Handler`で以下のような設定をすることで、ページのレンダリングを制御することができます。

```tsx
// 静的レンダリングを強制する
export const dynamic = 'force-static';
```

Router Segment Config は以下の 7 つの設定があります。

- [`dynamic`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#dynamic)
- [`dynamicParams`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#dynamicparams)
- [`revalidate`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#revalidate)
- [`fetchCache`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#fetchcache)
- [`runtime`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#runtime)
- [`preferredRegion`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#preferredregion)
- [`maxDuration`](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#maxduration)

https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config

## 1. dynamic

`dynamic` はそのページを静的または動的にレンダリングするかを制御します。
`layout.tsx`や`page.tsx`,`Route Handler`で以下のように宣言することで使用できます。

```tsx
export const dynamic = '...';
```

ページ全体を制御するため、App Router 以前の`Pages Router`からのスムーズに移行することができますとのことです。

> Good to know: The new model in the app directory favors granular caching control at the fetch request level over the binary all-or-nothing model of getServerSideProps and getStaticProps at the page-level in the pages directory. The dynamic option is a way to opt back in to the previous model as a convenience and provides a simpler migration path.

### auto

```tsx
export const dynamic = 'auto';
```

**デフォルト**。静的レンダリングになります。ですが、任意のコンポーネントは`fetch`を用いて動的にレンダリングすることができます。

### force-dynamic

```tsx
export const dynamic = 'force-dynamic';
```

完全に動的にレンダリングされるため、設定したページは SSR の挙動になります。
**`Pages Router`の`getServerSideProps()`を使用した場合と同じ挙動になります。**

:::message
同時に`fetch`の動作を検証した感じ、`fetch`に`cache`を指定していいない場合は、
`fetch(... ,{ cache:"no-store" })`になり、指定されている場合は、初回のみ
`fetch(... ,{ cache:"no-store" })`で実行され、以降は設定された`cache`の値で実行されます。
:::

### error

```tsx
export const dynamic = 'error';
```

完全に静的なレンダリングを作成し、`fetch`は常に`cache`を使用します。SSG と同じ挙動になります。
**`Pages Router`の`getStaticProps()`を使用した場合と同じ挙動になります。**
もし、そのページの配下のコンポーネントが`fetch(... ,{ cache:"no-store" })`や動的関数を使用している場合は、ビルド時にエラーが発生します。
