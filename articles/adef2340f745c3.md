---
title: 'ã€Reactã€‘ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« + æ¤œç´¢æ©Ÿèƒ½ä»˜ãSelect Boxã‚’ä½œã‚ã†'
emoji: 'ğŸ”'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['react', 'nextjs', 'typescript', 'javascript', 'web']
published: true
---

ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨æ¤œç´¢æ©Ÿèƒ½ã‚’æŒã¤ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
ä»–ã® UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚‚å¿œç”¨ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

## å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

![](/images/search/selecter.gif)

## ã¯ã˜ã‚ã«

### GitHub ã¨å®Œæˆã‚³ãƒ¼ãƒ‰

:::details å®Œæˆã‚³ãƒ¼ãƒ‰(UI å´)

```tsx
'use client';

import { Category } from '@prisma/client';
import { AlertTriangle, Check, ChevronsUpDown, Loader2 } from 'lucide-react';
import React, { Suspense, memo } from 'react';

import { useSearchCategories } from '@/components/category-selecter/use-search-categories';
import { Button } from '@/components/ui/button';
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
} from '@/components/ui/command';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Skeleton } from '@/components/ui/skeleton';
import { cn } from '@/lib/utils';

// æ¤œç´¢ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function SearchingLoader({ type }: { type: 'command' | 'item' }) {
  switch (type) {
    case 'command':
      return (
        <>
          <CommandInput disabled isLoading placeholder="Searching..." />
          <SearchingLoader type="item" />
        </>
      );
    case 'item':
      return (
        <div className="grid gap-2 p-2">
          {Array.from({ length: 5 }).map((_, i) => (
            <Skeleton key={`searching-loader-${i}`} className="h-8 w-full" />
          ))}
        </div>
      );
    default:
      return null;
  }
}

type CategoryItemProps = {
  category: Pick<Category, 'name'>;
  setOpen?: (value: boolean) => void;
  setCategory: (value: string) => void;
  value: string;
};

// ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const CategoryItem = memo(
  ({ category, setOpen, setCategory, value }: CategoryItemProps) => {
    return (
      <CommandItem
        key={category.name}
        className="mt-2 flex items-center justify-between text-sm capitalize first:mt-0"
        onSelect={(currentValue) => {
          setCategory(currentValue);
          setOpen?.(false);
        }}
        value={category.name}
      >
        <div className="flex items-center">
          <Check
            className={cn(
              'mr-2 h-4 w-4',
              category.name === value ? 'opacity-100' : 'opacity-0'
            )}
          />
          <span>{category.name}</span>
        </div>
      </CommandItem>
    );
  }
);

// ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function Categories({
  setOpen,
  setCategory,
  value,
}: {
  setOpen?: (value: boolean) => void;
  setCategory: (value: string) => void;
  value: string;
}) {
  const {
    categories,
    hasMore,
    onChangeQuery,
    isSearching,
    inputValue,
    setInputValue,
    fetchNextPage,
  } = useSearchCategories();

  return (
    <>
      <CommandInput
        isLoading={isSearching}
        onValueChange={(v) => {
          onChangeQuery(v);
          setInputValue(v);
        }}
        placeholder="Search category"
      />
      <CommandEmpty className="py-0 text-left text-sm">
        {isSearching ? (
          <SearchingLoader type="item" />
        ) : (
          // æ¤œç´¢çµæœãŒãªã„å ´åˆã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
          <div className="flex w-full flex-col  gap-4 overflow-hidden px-2 py-4">
            <div className="flex justify-center">
              <AlertTriangle className="size-8 text-muted-foreground" />
            </div>

            <div className="grid gap-2">
              <p className="text-center text-muted-foreground">Not Found for</p>
              <code className="line-clamp-1 max-w-full rounded-md bg-secondary p-2 text-destructive ">
                {inputValue}
              </code>
            </div>
            <Button className="flex items-center" variant="default">
              <span className="mx-2 line-clamp-1 max-w-44 flex-1">
                {inputValue}
              </span>
              <span>ã‚’ä½œæˆã™ã‚‹</span>
            </Button>
          </div>
        )}
      </CommandEmpty>
      <CommandGroup className="p-2">
        {categories.map((category) => (
          <CategoryItem
            key={category.name}
            category={category}
            setCategory={setCategory}
            setOpen={setOpen}
            value={value}
          />
        ))}
      </CommandGroup>
      // ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒœã‚¿ãƒ³
      {hasMore && (
        <div className="mb-2 border-t border-border px-2 pt-6">
          <Button
            className="w-full rounded-full"
            disabled={isSearching}
            onClick={() => fetchNextPage()}
            size="sm"
            variant="default"
          >
            {isSearching && <Loader2 className="mr-4 size-5 animate-spin" />}
            {isSearching ? 'Loading...' : 'Load more'}
          </Button>
        </div>
      )}
    </>
  );
}

export function CategorySelector() {
  // Popoverã®é–‹é–‰çŠ¶æ…‹ã‚’ç®¡ç†
  const [open, setOpen] = React.useState(false);
  // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ç®¡ç†
  const [value, setCategory] = React.useState('');

  return (
    <Popover onOpenChange={setOpen} open={open}>
      <PopoverTrigger asChild>
        <div className="group inline-block">
          <Button
            aria-expanded={open}
            className="mt-3 w-72 justify-between capitalize group-hover:bg-accent group-hover:text-accent-foreground sm:w-80"
            role="combobox"
            type="button"
            variant="outline"
          >
            {value || 'Select category'}
            <ChevronsUpDown className="ml-2 size-4 shrink-0 opacity-50" />
          </Button>
        </div>
      </PopoverTrigger>
      <PopoverContent className="max-h-80 min-h-48 w-72 overflow-auto p-0 sm:w-80">
        <Command>
          <Suspense fallback={<SearchingLoader type="command" />}>
            <Categories
              setCategory={setCategory}
              setOpen={setOpen}
              value={value}
            />
          </Suspense>
        </Command>
      </PopoverContent>
    </Popover>
  );
}
```

:::

:::details å®Œæˆã‚³ãƒ¼ãƒ‰(ãƒ­ã‚¸ãƒƒã‚¯å´)

```tsx
import { Category } from '@prisma/client';
import { useSuspenseInfiniteQuery } from '@tanstack/react-query';
import { useMemo, useState, useTransition } from 'react';
import { useDebouncedCallback } from 'use-debounce';

type Params = {
  q: string;
  offset: number;
};

type FetchResult = {
  categories: Pick<Category, 'name'>[];
  hasMore: boolean;
};

async function fetchCategories(params: Params): Promise<FetchResult> {
  const searchParams = new URLSearchParams();
  // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
  Object.entries(params).forEach(([key, value]) => {
    searchParams.set(key, value.toString());
  });

  const res = await fetch(`/api/categories?${searchParams.toString()}`);
  const data = (await res.json()) as FetchResult;

  return data;
}

function useQueryCategory(q: string) {
  const { data, isPending, hasNextPage, fetchNextPage, isFetchingNextPage } =
    useSuspenseInfiniteQuery({
      queryKey: ['categories', 'search', { q }],
      queryFn: ({ pageParam }: { pageParam: Params }) => {
        return fetchCategories(pageParam);
      },
      // åˆæœŸãƒšãƒ¼ã‚¸ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      initialPageParam: { q, offset: 0 },
      // æ¬¡ã®ãƒšãƒ¼ã‚¸ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      getNextPageParam: (lastPage, _, lastPageParam) => {
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒãªã„å ´åˆã¯undefinedã‚’è¿”ã™
        if (lastPage.categories.length === 0) return undefined;
        // ã‚‚ã†ãƒšãƒ¼ã‚¸ãŒãªã„å ´åˆã¯undefinedã‚’è¿”ã™
        if (!lastPage.hasMore) return undefined;

        // 10ä»¶ãšã¤å–å¾—ã™ã‚‹
        return {
          q: lastPageParam.q,
          offset: lastPageParam.offset + 10,
        };
      },
    });

  // UIå´ã§å‡¦ç†ã—ã‚„ã™ã„ã‚ˆã†ã«äºŒé‡é…åˆ—ã‚’ãƒ•ãƒ©ãƒƒãƒˆã«ã™ã‚‹
  const categories = useMemo(() => {
    return data?.pages.flatMap((page) => page.categories) ?? [];
  }, [data?.pages]);

  return {
    isPending: isPending || isFetchingNextPage,
    categories,
    hasMore: hasNextPage,
    fetchNextPage,
  };
}

export function useSearchCategories() {
  // å…¥åŠ›ã—ã¦ã„ã‚‹å€¤ã‚’è¡¨ç¤ºã™ã‚‹çŠ¶æ…‹
  const [inputValue, setInputValue] = useState('');
  // æ¤œç´¢æ–‡å­—åˆ—ã®çŠ¶æ…‹
  const [q, setQ] = useState('');
  const [isTransition, startTransition] = useTransition();

  const { hasMore, categories, isPending, fetchNextPage } = useQueryCategory(q);

  // ã™ãã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€useDebouncedCallback ã‚’ä½¿ç”¨
  const onChangeQuery = useDebouncedCallback((val: string) => {
    startTransition(() => {
      setQ(val.toLowerCase());
    });
  }, 500);

  // æ¤œç´¢ä¸­ã®çŠ¶æ…‹ã‚’ç®¡ç†
  const isSearching =
    isPending || isTransition || inputValue.toLowerCase() !== q.toLowerCase();

  return {
    onChangeQuery,
    isSearching,
    inputValue,
    setInputValue,
    categories,
    hasMore,
    fetchNextPage,
  };
}
```

:::

https://github.com/shouta0715/zenn-playground/tree/main/src/components/category-selecter

### ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

https://ui.shadcn.com/docs/components/combobox

https://tanstack.com/query/latest

https://www.npmjs.com/package/use-debounce

## å¿…è¦ãªéƒ¨å“ (UI å´)

### 1. æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®ãƒˆãƒªã‚¬ãƒ¼

- shadcn ã®[Popver](https://ui.shadcn.com/docs/components/popover)ã¨[Command](https://ui.shadcn.com/docs/components/command)ã‚’çµ„ã¿åˆã‚ã›ã¦[Combobox](https://ui.shadcn.com/docs/components/combobox)ã‚’ä½œæˆã—ã¾ã™ã€‚

### 2. ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä»˜ãã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹

- [Command](https://ui.shadcn.com/docs/components/command)ã‚’ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹ã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### 3. ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

- æ¤œç´¢æ¬„ã«æ–‡å­—ã‚’å…¥åŠ›ã™ã‚‹ãŸã³ã«ã€å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¨ã€ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã‚¢ã‚¤ãƒ†ãƒ ãŒè¿½åŠ ã•ã‚ŒãŸéš›ã«ã€éå¸¸ã«å‡¦ç†ãŒé‡ããªã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’è€ƒæ…®ã—ãªãŒã‚‰ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

## å¿…è¦ãªéƒ¨å“ (ãƒ­ã‚¸ãƒƒã‚¯å´)

### 1. å…¥åŠ›å€¤ã¨ãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹ã®ç®¡ç†

- æ¤œç´¢æ–‡å­—åˆ—ã®çŠ¶æ…‹ã€å…¥åŠ›æ–‡å­—åˆ—ã®çŠ¶æ…‹ã€ãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹ã®çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¾ã™ã€‚ã¾ãŸã€`useDebouncedCallback`ã‚’ä½¿ç”¨ã—ã¦ã€éå‰°ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

### 2. Tanstack Query ã‚’ä½¿ç”¨ã—ãŸç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å®Ÿè£…

- ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®çŠ¶æ…‹ç®¡ç†ã‚’è¡Œã†ã€‚

### 3. ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å‡¦ç†

- æ¤œç´¢æ–‡å­—åˆ—ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ä¸Šè¨˜ã®å¿…è¦ãªéƒ¨å“ã‚’ 1 ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

## å®Ÿè£…

:::details å®Œæˆã‚³ãƒ¼ãƒ‰(UI å´)

```tsx
'use client';

import { Category } from '@prisma/client';
import { AlertTriangle, Check, ChevronsUpDown, Loader2 } from 'lucide-react';
import React, { Suspense, memo } from 'react';

import { useSearchCategories } from '@/components/category-selecter/use-search-categories';
import { Button } from '@/components/ui/button';
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
} from '@/components/ui/command';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Skeleton } from '@/components/ui/skeleton';
import { cn } from '@/lib/utils';

// æ¤œç´¢ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function SearchingLoader({ type }: { type: 'command' | 'item' }) {
  switch (type) {
    case 'command':
      return (
        <>
          <CommandInput disabled isLoading placeholder="Searching..." />
          <SearchingLoader type="item" />
        </>
      );
    case 'item':
      return (
        <div className="grid gap-2 p-2">
          {Array.from({ length: 5 }).map((_, i) => (
            <Skeleton key={`searching-loader-${i}`} className="h-8 w-full" />
          ))}
        </div>
      );
    default:
      return null;
  }
}

type CategoryItemProps = {
  category: Pick<Category, 'name'>;
  setOpen?: (value: boolean) => void;
  setCategory: (value: string) => void;
  value: string;
};

// ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const CategoryItem = memo(
  ({ category, setOpen, setCategory, value }: CategoryItemProps) => {
    return (
      <CommandItem
        key={category.name}
        className="mt-2 flex items-center justify-between text-sm capitalize first:mt-0"
        onSelect={(currentValue) => {
          setCategory(currentValue);
          setOpen?.(false);
        }}
        value={category.name}
      >
        <div className="flex items-center">
          <Check
            className={cn(
              'mr-2 h-4 w-4',
              category.name === value ? 'opacity-100' : 'opacity-0'
            )}
          />
          <span>{category.name}</span>
        </div>
      </CommandItem>
    );
  }
);

// ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function Categories({
  setOpen,
  setCategory,
  value,
}: {
  setOpen?: (value: boolean) => void;
  setCategory: (value: string) => void;
  value: string;
}) {
  const {
    categories,
    hasMore,
    onChangeQuery,
    isSearching,
    inputValue,
    setInputValue,
    fetchNextPage,
  } = useSearchCategories();

  return (
    <>
      <CommandInput
        isLoading={isSearching}
        onValueChange={(v) => {
          onChangeQuery(v);
          setInputValue(v);
        }}
        placeholder="Search category"
      />
      <CommandEmpty className="py-0 text-left text-sm">
        {isSearching ? (
          <SearchingLoader type="item" />
        ) : (
          // æ¤œç´¢çµæœãŒãªã„å ´åˆã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
          <div className="flex w-full flex-col  gap-4 overflow-hidden px-2 py-4">
            <div className="flex justify-center">
              <AlertTriangle className="size-8 text-muted-foreground" />
            </div>

            <div className="grid gap-2">
              <p className="text-center text-muted-foreground">Not Found for</p>
              <code className="line-clamp-1 max-w-full rounded-md bg-secondary p-2 text-destructive ">
                {inputValue}
              </code>
            </div>
            <Button className="flex items-center" variant="default">
              <span className="mx-2 line-clamp-1 max-w-44 flex-1">
                {inputValue}
              </span>
              <span>ã‚’ä½œæˆã™ã‚‹</span>
            </Button>
          </div>
        )}
      </CommandEmpty>
      <CommandGroup className="p-2">
        {categories.map((category) => (
          <CategoryItem
            key={category.name}
            category={category}
            setCategory={setCategory}
            setOpen={setOpen}
            value={value}
          />
        ))}
      </CommandGroup>
      // ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒœã‚¿ãƒ³
      {hasMore && (
        <div className="mb-2 border-t border-border px-2 pt-6">
          <Button
            className="w-full rounded-full"
            disabled={isSearching}
            onClick={() => fetchNextPage()}
            size="sm"
            variant="default"
          >
            {isSearching && <Loader2 className="mr-4 size-5 animate-spin" />}
            {isSearching ? 'Loading...' : 'Load more'}
          </Button>
        </div>
      )}
    </>
  );
}

export function CategorySelector() {
  // Popoverã®é–‹é–‰çŠ¶æ…‹ã‚’ç®¡ç†
  const [open, setOpen] = React.useState(false);
  // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ç®¡ç†
  const [value, setCategory] = React.useState('');

  return (
    <Popover onOpenChange={setOpen} open={open}>
      <PopoverTrigger asChild>
        <div className="group inline-block">
          <Button
            aria-expanded={open}
            className="mt-3 w-72 justify-between capitalize group-hover:bg-accent group-hover:text-accent-foreground sm:w-80"
            role="combobox"
            type="button"
            variant="outline"
          >
            {value || 'Select category'}
            <ChevronsUpDown className="ml-2 size-4 shrink-0 opacity-50" />
          </Button>
        </div>
      </PopoverTrigger>
      <PopoverContent className="max-h-80 min-h-48 w-72 overflow-auto p-0 sm:w-80">
        <Command>
          <Suspense fallback={<SearchingLoader type="command" />}>
            <Categories
              setCategory={setCategory}
              setOpen={setOpen}
              value={value}
            />
          </Suspense>
        </Command>
      </PopoverContent>
    </Popover>
  );
}
```

:::

:::details å®Œæˆã‚³ãƒ¼ãƒ‰(ãƒ­ã‚¸ãƒƒã‚¯å´)

```tsx
import { Category } from '@prisma/client';
import { useSuspenseInfiniteQuery } from '@tanstack/react-query';
import { useMemo, useState, useTransition } from 'react';
import { useDebouncedCallback } from 'use-debounce';

type Params = {
  q: string;
  offset: number;
};

type FetchResult = {
  categories: Pick<Category, 'name'>[];
  hasMore: boolean;
};

async function fetchCategories(params: Params): Promise<FetchResult> {
  const searchParams = new URLSearchParams();
  // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
  Object.entries(params).forEach(([key, value]) => {
    searchParams.set(key, value.toString());
  });

  const res = await fetch(`/api/categories?${searchParams.toString()}`);
  const data = (await res.json()) as FetchResult;

  return data;
}

function useQueryCategory(q: string) {
  const { data, isPending, hasNextPage, fetchNextPage, isFetchingNextPage } =
    useSuspenseInfiniteQuery({
      queryKey: ['categories', 'search', { q }],
      queryFn: ({ pageParam }: { pageParam: Params }) => {
        return fetchCategories(pageParam);
      },
      // åˆæœŸãƒšãƒ¼ã‚¸ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      initialPageParam: { q, offset: 0 },
      // æ¬¡ã®ãƒšãƒ¼ã‚¸ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      getNextPageParam: (lastPage, _, lastPageParam) => {
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒãªã„å ´åˆã¯undefinedã‚’è¿”ã™
        if (lastPage.categories.length === 0) return undefined;
        // ã‚‚ã†ãƒšãƒ¼ã‚¸ãŒãªã„å ´åˆã¯undefinedã‚’è¿”ã™
        if (!lastPage.hasMore) return undefined;

        // 10ä»¶ãšã¤å–å¾—ã™ã‚‹
        return {
          q: lastPageParam.q,
          offset: lastPageParam.offset + 10,
        };
      },
    });

  // UIå´ã§å‡¦ç†ã—ã‚„ã™ã„ã‚ˆã†ã«äºŒé‡é…åˆ—ã‚’ãƒ•ãƒ©ãƒƒãƒˆã«ã™ã‚‹
  const categories = useMemo(() => {
    return data?.pages.flatMap((page) => page.categories) ?? [];
  }, [data?.pages]);

  return {
    isPending: isPending || isFetchingNextPage,
    categories,
    hasMore: hasNextPage,
    fetchNextPage,
  };
}

export function useSearchCategories() {
  // å…¥åŠ›ã—ã¦ã„ã‚‹å€¤ã‚’è¡¨ç¤ºã™ã‚‹çŠ¶æ…‹
  const [inputValue, setInputValue] = useState('');
  // æ¤œç´¢æ–‡å­—åˆ—ã®çŠ¶æ…‹
  const [q, setQ] = useState('');
  const [isTransition, startTransition] = useTransition();

  const { hasMore, categories, isPending, fetchNextPage } = useQueryCategory(q);

  // ã™ãã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€useDebouncedCallback ã‚’ä½¿ç”¨
  const onChangeQuery = useDebouncedCallback((val: string) => {
    startTransition(() => {
      setQ(val.toLowerCase());
    });
  }, 500);

  // æ¤œç´¢ä¸­ã®çŠ¶æ…‹ã‚’ç®¡ç†
  const isSearching =
    isPending || isTransition || inputValue.toLowerCase() !== q.toLowerCase();

  return {
    onChangeQuery,
    isSearching,
    inputValue,
    setInputValue,
    categories,
    hasMore,
    fetchNextPage,
  };
}
```

:::

### UI å´

### 1. æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®ãƒˆãƒªã‚¬ãƒ¼

:::details å®Œæˆã‚³ãƒ¼ãƒ‰

```tsx
export function CategorySelector() {
  // popoverã®é–‹é–‰çŠ¶æ…‹ã‚’ç®¡ç†
  const [open, setOpen] = React.useState(false);

  // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ç®¡ç†
  const [value, setCategory] = React.useState('');

  return (
    <Popover onOpenChange={setOpen} open={open}>
      <PopoverTrigger asChild>
        <div className="group inline-block">
          <Button
            aria-expanded={open}
            className="mt-3 w-72 justify-between capitalize group-hover:bg-accent group-hover:text-accent-foreground sm:w-80"
            role="combobox"
            type="button"
            variant="outline"
          >
            {value || 'Select category'}
            <ChevronsUpDown className="ml-2 size-4 shrink-0 opacity-50" />
          </Button>
        </div>
      </PopoverTrigger>
      <PopoverContent className="max-h-80 min-h-48 w-72 overflow-auto p-0 sm:w-80">
        <Command>
          <Suspense fallback={<SearchingLoader type="command" />}>
            <Categories
              setCategory={setCategory}
              setOpen={setOpen}
              value={value}
            />
          </Suspense>
        </Command>
      </PopoverContent>
    </Popover>
  );
}
```

:::

UI ã«é–¢ã—ã¦ã¯åŸºæœ¬çš„ã« shadcn ã®[Combobox ã® Examples](https://ui.shadcn.com/docs/components/combobox#examples)ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

`open`ã®`useState`ã¯ Popover ã®é–‹é–‰çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ã€`value`ã¯ Select Box ã§é¸æŠã•ã‚ŒãŸå€¤ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

#### Select Box ã®é–‹é–‰çŠ¶æ…‹ã¨é¸æŠã•ã‚ŒãŸå€¤ã®ç®¡ç†

```tsx
export function CategorySelector() {
  // popoverã®é–‹é–‰çŠ¶æ…‹ã‚’ç®¡ç†
  const [open, setOpen] = React.useState(false);

  // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ç®¡ç†
  const [value, setCategory] = React.useState("");

  // ...
```

### 2. ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä»˜ãã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹

:::details å®Œæˆã‚³ãƒ¼ãƒ‰

```tsx
function Categories({
  setOpen,
  setCategory,
  value,
}: {
  setOpen?: (value: boolean) => void;
  setCategory: (value: string) => void;
  value: string;
}) {
  const {
    categories,
    hasMore,
    onChangeQuery,
    isSearching,
    inputValue,
    setInputValue,
    fetchNextPage,
  } = useSearchCategories();

  return (
    <>
      <CommandInput
        isLoading={isSearching}
        onValueChange={(v) => {
          onChangeQuery(v);
          setInputValue(v);
        }}
        placeholder="Search category"
      />
      <CommandEmpty className="py-0 text-left text-sm">
        {isSearching ? (
          <SearchingLoader type="item" />
        ) : (
          // æ¤œç´¢çµæœãŒãªã„å ´åˆã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
          <div className="flex w-full flex-col  gap-4 overflow-hidden px-2 py-4">
            <div className="flex justify-center">
              <AlertTriangle className="size-8 text-muted-foreground" />
            </div>

            <div className="grid gap-2">
              <p className="text-center text-muted-foreground">Not Found for</p>
              <code className="line-clamp-1 max-w-full rounded-md bg-secondary p-2 text-destructive ">
                {inputValue}
              </code>
            </div>
            <Button className="flex items-center" variant="default">
              <span className="mx-2 line-clamp-1 max-w-44 flex-1">
                {inputValue}
              </span>
              <span>ã‚’ä½œæˆã™ã‚‹</span>
            </Button>
          </div>
        )}
      </CommandEmpty>
      <CommandGroup className="p-2">
        {categories.map((category) => (
          <CategoryItem
            key={category.name}
            category={category}
            setCategory={setCategory}
            setOpen={setOpen}
            value={value}
          />
        ))}
      </CommandGroup>
      // ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒœã‚¿ãƒ³
      {hasMore && (
        <div className="mb-2 border-t border-border px-2 pt-6">
          <Button
            className="w-full rounded-full"
            disabled={isSearching}
            onClick={() => fetchNextPage()}
            size="sm"
            variant="default"
          >
            {isSearching && <Loader2 className="mr-4 size-5 animate-spin" />}
            {isSearching ? 'Loading...' : 'Load more'}
          </Button>
        </div>
      )}
    </>
  );
}
```

:::

#### `CommandInput`ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹

```tsx
const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input> & {
    isLoading?: boolean;
  }
>(({ className, isLoading = false, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    // isLoadingãŒtrueã®å ´åˆã¯ãƒ­ãƒ¼ãƒ‰ä¸­ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
    {isLoading ? (
      <Loader2 className="mr-2 size-4 shrink-0 animate-spin opacity-50" />
    ) : (
      <Search className="mr-2 size-4 shrink-0 opacity-50" />
    )}
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        'flex h-11 w-full rounded-md bg-transparent py-3 text-[16px] outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50',
        className
      )}
      {...props}
    />
  </div>
));
```

ã¾ãšã€ä¸Šè¨˜ã®ã‚ˆã†ã« shadcn ã®`CommandInput`ã‚’ä¿®æ­£ã—ã¦ã€`isLoading`ãŒ`true`ã®å ´åˆã¯ãƒ­ãƒ¼ãƒ‰ä¸­ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
æ¤œç´¢ä¸­ã¯ãã‚‹ãã‚‹ãƒãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã€æ¤œç´¢ä¸­ã§ãªã„å ´åˆã¯æ¤œç´¢ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

#### ãƒ­ãƒ¼ãƒ‰ä¸­ã¨æ¤œç´¢çµæœãŒãªã„å ´åˆã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
function SearchingLoader() {
  return (
    <div className="grid gap-2 p-2">
      {Array.from({ length: 5 }).map((_, i) => (
        <Skeleton key={`searching-loader-${i}`} className="h-8 w-full" />
      ))}
    </div>
  );
}
```

```tsx
<CommandEmpty className="py-0 text-left text-sm">
  {isSearching ? (
    <SearchingLoader type="item" />
  ) : (
    // æ¤œç´¢çµæœãŒãªã„å ´åˆã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    <div className="flex w-full flex-col  gap-4 overflow-hidden px-2 py-4">
      <div className="flex justify-center">
        <AlertTriangle className="size-8 text-muted-foreground" />
      </div>

      <div className="grid gap-2">
        <p className="text-center text-muted-foreground">Not Found for</p>
        <code className="line-clamp-1 max-w-full rounded-md bg-secondary p-2 text-destructive ">
          {inputValue}
        </code>
      </div>
      <Button className="flex items-center" variant="default">
        <span className="mx-2 line-clamp-1 max-w-44 flex-1">{inputValue}</span>
        <span>ã‚’ä½œæˆã™ã‚‹</span>
      </Button>
    </div>
  )}
</CommandEmpty>
```

`useSearchCategories`ã¯å¾Œè¿°ã—ã¾ã™ãŒã€æ¤œç´¢æ–‡å­—åˆ—ã®çŠ¶æ…‹ã€å…¥åŠ›æ–‡å­—åˆ—ã®çŠ¶æ…‹ã€ãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹ã®çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¾ã™ã€‚
`useSearchCategories`ã® isSearching ãŒ`true`ã®å ´åˆã¯ä¸Šè¨˜ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

`CommandEmpty`ã¯æ¤œç´¢çµæœãŒãªã„å ´åˆã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚
æ¤œç´¢çµæœãŒãªã„å ´åˆã‹ã¤ã€æ¤œç´¢ä¸­ã§ãªã„å ´åˆã« **ä½œæˆã™ã‚‹ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™**ã€‚

### 3. ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

:::details å®Œæˆã‚³ãƒ¼ãƒ‰

```tsx
const CategoryItem = memo(
  ({ category, setOpen, setCategory, value }: CategoryItemProps) => {
    return (
      <CommandItem
        key={category.name}
        className="mt-2 flex items-center justify-between text-sm capitalize first:mt-0"
        onSelect={(currentValue) => {
          setCategory(currentValue);
          setOpen?.(false);
        }}
        value={category.name}
      >
        <div className="flex items-center">
          <Check
            className={cn(
              'mr-2 h-4 w-4',
              category.name === value ? 'opacity-100' : 'opacity-0'
            )}
          />
          <span>{category.name}</span>
        </div>
      </CommandItem>
    );
  }
);
```

:::

#### `memo`ã‚’ä½¿ç”¨ã™ã‚‹

```tsx
const CategoryItem = memo(() => {
  // ...
});
```

`useMemo`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€å…¥åŠ›æ¬„ã«æ–‡å­—ã‚’å…¥åŠ›ã™ã‚‹ãŸã³ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨ã‚’é˜²ãã¾ã™ã€‚
`useMemo`ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„å ´åˆã€ç„¡é™ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã‚¢ã‚¤ãƒ†ãƒ ãŒè¿½åŠ ã•ã‚ŒãŸéš›ã«ã€éå¸¸ã«å‡¦ç†ãŒé‡ããªã‚Šã¾ã™ã€‚

### ãƒ­ã‚¸ãƒƒã‚¯å´

### 1. å…¥åŠ›å€¤ã¨ãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹ã®ç®¡ç†

:::details å®Œæˆã‚³ãƒ¼ãƒ‰

```ts
export function useSearchCategories() {
  // å…¥åŠ›å€¤ã®çŠ¶æ…‹ã‚’ç®¡ç†
  const [inputValue, setInputValue] = useState('');
  // æ¤œç´¢æ–‡å­—åˆ—ã®çŠ¶æ…‹ã‚’ç®¡ç†
  const [q, setQ] = useState('');
  const [isTransition, startTransition] = useTransition();

  const { hasMore, categories, isPending, fetchNextPage } = useQueryCategory(q);

  // ã™ãã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€useDebouncedCallback ã‚’ä½¿ç”¨
  const onChangeQuery = useDebouncedCallback((val: string) => {
    startTransition(() => {
      setQ(val.toLowerCase());
    });
  }, 500);

  // æ¤œç´¢ä¸­ã®çŠ¶æ…‹ã‚’ç®¡ç†
  const isSearching =
    isPending || isTransition || inputValue.toLowerCase() !== q.toLowerCase();

  return {
    onChangeQuery,
    isSearching,
    inputValue,
    setInputValue,
    categories,
    hasMore,
    fetchNextPage,
  };
}
```

:::

```ts
// å…¥åŠ›å€¤ã®çŠ¶æ…‹ã‚’ç®¡ç†
const [inputValue, setInputValue] = useState('');
// æ¤œç´¢æ–‡å­—åˆ—ã®çŠ¶æ…‹ã‚’ç®¡ç†
const [q, setQ] = useState('');
const [isTransition, startTransition] = useTransition();

// ã™ãã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€useDebouncedCallback ã‚’ä½¿ç”¨
const onChangeQuery = useDebouncedCallback((val: string) => {
  startTransition(() => {
    setQ(val.toLowerCase());
  });
}, 500);
```

å…¥åŠ›å€¤ã¨æ¤œç´¢æ–‡å­—åˆ—ã®çŠ¶æ…‹ã‚’åˆ†ã‘ã‚‹ç†ç”±ã¯ã€`useDebouncedCallback`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€`state`ã«åæ˜ ã™ã‚‹æ™‚é–“ãŒé…ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã¾ã§é…å»¶ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã§ã™ã€‚
ãã®ãŸã‚ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã® state**ã¨**ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã® state**ã‚’åˆ†ã‘ã¦ã„ã¾ã™ã€‚

`useTransition`ã¯ã€å‡¦ç†ã‚’é…å»¶ã•ã›ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ä»Šå›ã®å ´åˆã¯ã‚ã¾ã‚Šæ©æµãŒã‚ã‚Šã¾ã›ã‚“ãŒã€å…¥åŠ›æ–‡å­—åˆ—ã‚’**URL ã‚¯ã‚¨ãƒª**ã«å¤‰æ›ã™ã‚‹éš›ãªã©ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€åæ˜ ä¸­ã‹ã©ã†ã‹ã‚’`isTransition`ã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### æ¤œç´¢ä¸­ã®çŠ¶æ…‹ã‚’ç®¡ç†

```ts
const isSearching =
  isPending || isTransition || inputValue.toLowerCase() !== q.toLowerCase();
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®ã€`inputValue.toLowerCase() !== q.toLowerCase();`ã¯ã€å…¥åŠ›æ–‡å­—åˆ—ã¨æ¤œç´¢æ–‡å­—åˆ—ãŒç•°ãªã‚‹å ´åˆã¯æ¤œç´¢ä¸­ã®ï¼ˆã¾ã çµæœãŒã‚ã‹ã‚‰ãªã„ï¼‰çŠ¶æ…‹ãªã®ã§ã€`isSearching`ã‚’`true`ã«ã—ã¦ã„ã¾ã™ã€‚

### 2. Tanstack Query ã‚’ä½¿ç”¨ã—ãŸç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å®Ÿè£…

:::details å®Œæˆã‚³ãƒ¼ãƒ‰

```ts
function useQueryCategory(q: string) {
  const { data, isPending, hasNextPage, fetchNextPage, isFetchingNextPage } =
    useSuspenseInfiniteQuery({
      queryKey: ['categories', 'search', { q }],
      queryFn: ({ pageParam }: { pageParam: Params }) => {
        return fetchCategories(pageParam);
      },
      initialPageParam: { q, offset: 0 },
      getNextPageParam: (lastPage, _, lastPageParam) => {
        if (lastPage.categories.length === 0) return undefined;
        if (!lastPage.hasMore) return undefined;

        return {
          q: lastPageParam.q,
          offset: lastPageParam.offset + 10,
        };
      },
    });

  const categories = useMemo(() => {
    return data?.pages.flatMap((page) => page.categories) ?? [];
  }, [data?.pages]);

  return {
    isPending: isPending || isFetchingNextPage,
    categories,
    hasMore: hasNextPage,
    fetchNextPage,
  };
}
```

:::

key ãªã©ã«é–¢ã—ã¦ã¯ã€é€šå¸¸ã®`useQuery`ã¨åŒã˜ã§ã™ã€‚

#### `initialPageParam`ã¨`getNextPageParam`ã«ã¤ã„ã¦

```ts
useSuspenseInfiniteQuery({
  // ...
  initialPageParam: { q, offset: 0 },
  getNextPageParam: (lastPage, _, lastPageParam) => {
    if (lastPage.categories.length === 0) return undefined;
    if (!lastPage.hasMore) return undefined;

    return {
      q: lastPageParam.q,
      offset: lastPageParam.offset + 10,
    };
  },
});
```

`initialPageParam`ã¯ 1 å›ç›®ã®`queryFn`ã«æ¸¡ã•ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã™ã€‚
`getNextPageParam`ã¯ 2 å›ç›®ä»¥é™ã®`queryFn`ã«æ¸¡ã•ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã™ã€‚10 ä»¶ãšã¤å–å¾—ã™ã‚‹ãŸã‚ã«`offset`ã‚’`10`ãšã¤å¢—ã‚„ã—ã¦ã„ã¾ã™ã€‚`getNextPageParam`ã®å‹ã¯`fetchFn`ã®å¼•æ•°ã¨åŒã˜ã§ã™ã€‚

`getNextPageParam`ã§`undefined`ã‚’è¿”ã™ã¨ã€`useSuspenseInfiniteQuery`ã®`hasNextPage`ãŒ`false`ã«ãªã‚Šã¾ã™ã€‚
ä»Šå›ã®å ´åˆã¯ã€ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰è¿”ã£ã¦ãã‚‹`hasMore`ãŒ`false`ã‹æœ€å¾Œã«å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒ`0`ä»¶ã®å ´åˆã«`undefined`ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚

ãã®ä»–ã®å¼•æ•°ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://tanstack.com/query/latest/docs/framework/react/reference/useInfiniteQuery

#### UI å´ã§å‡¦ç†ã—ã‚„ã™ã„ã‚ˆã†ã«äºŒé‡é…åˆ—ã‚’ãƒ•ãƒ©ãƒƒãƒˆã«ã™ã‚‹

```ts
const categories = useMemo(() => {
  return data?.pages.flatMap((page) => page.categories) ?? [];
}, [data?.pages]);
```

`useInfiniteQuery`ã®`data.pages`ã«ã¯å€¤ãŒæ ¼ç´ã•ã‚Œã¾ã™ãŒã€äºŒé‡é…åˆ—ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€`flatMap`ã‚’ä½¿ç”¨ã—ã¦ä¸€ã¤ã®é…åˆ—ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€UI å´ã§å‡¦ç†ãŒå˜ç´”åŒ–ã—ã¦è¦‹ã‚„ã™ããªã‚Šã¾ã™ã€‚

### 3. ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å‡¦ç†

:::details å®Œæˆã‚³ãƒ¼ãƒ‰

```ts
async function fetchCategories(params: Params): Promise<FetchResult> {
  const searchParams = new URLSearchParams();
  Object.entries(params).forEach(([key, value]) => {
    searchParams.set(key, value.toString());
  });

  const res = await fetch(`/api/categories?${searchParams.toString()}`);
  const data = (await res.json()) as FetchResult;

  return data;
}
```

:::

#### ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ

```ts
const searchParams = new URLSearchParams();
Object.entries(params).forEach(([key, value]) => {
  searchParams.set(key, value.toString());
});
```

å—ã‘å–ã£ãŸ**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ã‚’**URL ã‚¯ã‚¨ãƒª**ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚
æ„å¤–ã¨ Next.js ã§**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹éš›ã«**ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

## ã¾ã¨ã‚

`useInfiniteQuery`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å®Ÿè£…ã—ã€`useDebouncedCallback`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€æ¤œç´¢æ¬„ã«å…¥åŠ›ãŒã‚ã‚‹å ´åˆã«æ¯å›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã®ã§ã¯ãªãã€å…¥åŠ›ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»Šå›ã¯ãƒœã‚¿ãƒ³ã§æ›´ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ãŒã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«åˆã‚ã›ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
`Tanstack Query`ã®`useInfiniteQuery`ã¯**ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«**ã®å®Ÿè£…ã«éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚

## ã•ã„ã”ã«

ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä»¥å¤–ã«ã‚‚ã€è‰²ã€…ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã“ã†ã¨æƒ³ã„ã¾ã™ã€‚
ã‚‚ã—ã€é–“é•ã„ã‚„æ”¹å–„ç‚¹ã‚„è³ªå•ãŒã‚ã‚Œã°ã€ã‚³ãƒ¡ãƒ³ãƒˆã§æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ã©ã‚“ã©ã‚“ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ãäºˆå®šã§ã™ã€‚
https://zenn.dev/shouta0715/articles/38e89f49ca6d42

ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
